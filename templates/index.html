{% extends "layout.html" %}

{% block title %}GMC Scout V1{% endblock %}

{% block content %}
<!-- Hero Section -->
<!-- Use a compact hero area with only the logo and minimal vertical padding -->
<!-- Reduce vertical space in the hero by adding minimal padding -->
<section class="bg-black dark:bg-black py-0">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <!-- Display only the GMC Scout logo; remove heading text for a cleaner look -->
            <!-- Enlarge the GMC Scout logo while keeping the hero section compact. -->
            <img src="{{ url_for('static', filename='images/gmcscout_logo.png') }}" alt="GMC Scout Logo" class="mx-auto w-96 mb-0">
            <!-- Subtext describing GMC Scout, rendered in a monospaced font to evoke a coder/AI theme. -->
            <p class="mt-0 text-yellow-200 font-mono text-sm max-w-3xl mx-auto leading-relaxed">
                <span class="text-yellow-200">&lt;/&gt;</span>
                GMC&nbsp;Scout is the next generation tool for Google&nbsp;Merchant&nbsp;Center compliance. Developed by GMC experts with 5&nbsp;years of handsâ€‘on experience and enhanced by AI that evolves as fast as Google's policies change. Our comprehensive platform analyzes 1,000+ compliance data points to identify issues before they impact your store. Save hours, days and weeks of manual checking. Save money on costly violations. Get your GMC and stores live faster with GMC&nbsp;Scout as your trusted compliance guide.
                <span class="text-yellow-200">&lt;/..&gt;</span>
            </p>
        </div>
    </div>
</section>

<!-- Main Tool Section -->
<section class="py-4 lg:py-6">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Affiliate promotion removed per request -->

        <!-- Error Message Container -->
        <div id="error-message" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>
        
        <!-- Crawl Form -->
        <div id="crawl-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-8">
            <div class="text-center mb-8">
                <!-- Prompt users to begin a compliance scan by entering their store domain -->
                <p class="text-gray-600 dark:text-gray-400 text-base">
                    Enter a domain to start a comprehensive compliance analysis
                </p>
            </div>

            <!-- Information button (question mark) to open a modal with details about GMC Scout -->
            <div class="flex justify-end mb-4">
                <button id="info-btn" type="button" aria-label="About GMC Scout" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 focus:outline-none">
                    <i class="fas fa-info-circle text-xl"></i>
                </button>
            </div>

            <form id="crawl-form" class="space-y-6">
                <div>
                    <label for="url-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Your Store Domain
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="url-input" 
                            placeholder="https://yourwebsite.com" 
                            class="w-full px-4 py-3 pl-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white text-lg"
                            required
                        >
                        <i class="fas fa-globe w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- CAPTCHA Section -->
                <div id="captcha-container" class="">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        CAPTCHA
                    </label>
                    <div class="flex items-center space-x-2">
                        <span id="captcha-question" class="text-gray-700 dark:text-gray-300 text-sm"></span>
                        <input type="text" id="captcha-answer" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md w-24 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Answer" required>
                        <button type="button" id="refresh-captcha" class="text-sm text-primary-600 hover:text-primary-700 focus:outline-none">Refresh</button>
                    </div>
                </div>

                <button 
                    type="submit" 
                    id="start-crawl-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2"
                >
                    <i class="fas fa-search w-5 h-5"></i>
                    <span>Start GMC Scout</span>
                </button>
            </form>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-8 mt-8">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    Analyzing Your Store
                </h3>
                <p class="text-gray-600 dark:text-gray-400">
                    GMC Scout is searching your store for potential GMC issues
                </p>
            </div>

            <div class="space-y-4">
                <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                    <!-- A thicker, green progress bar that clearly shows scanning progress -->
                    <div id="progress-bar" class="bg-green-600 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Compliance circular progress bar -->
                <div class="flex justify-center">
                    <!-- Increase the size of the live compliance bar for better visibility.  Set a
                         transparent background so no grey box shows behind the SVG. -->
                    <div class="relative" style="width: 160px; height: 160px; background: transparent;">
                        <svg id="compliance-svg-progress" viewBox="0 0 36 36" class="w-full h-full" style="background: transparent; overflow: visible;">
                            <!-- Define gradients to give the progress bar a premium, shiny look. Each gradient
                                 corresponds to a different compliance tier.  Gradients transition from a
                                 lighter tint to a deeper hue for added depth.  The gradient IDs are
                                 prefixed with 'progress' to avoid collisions with the results bar. -->
                            <defs>
                                <linearGradient id="progress-green-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#6EE7B7" />
                                    <stop offset="100%" stop-color="#059669" />
                                </linearGradient>
                                <linearGradient id="progress-orange-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#FCD34D" />
                                    <stop offset="100%" stop-color="#EA580C" />
                                </linearGradient>
                                <linearGradient id="progress-yellow-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#FDE68A" />
                                    <stop offset="100%" stop-color="#EAB308" />
                                </linearGradient>
                                <linearGradient id="progress-red-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#FCA5A5" />
                                    <stop offset="100%" stop-color="#B91C1C" />
                                </linearGradient>
                            </defs>
                            <!-- Background circle -->
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#FFFFFF" stroke-width="4.5"></path>
                            <!-- Dynamic progress circle; stroke will be set to a gradient via JS -->
                            <path id="compliance-bar-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="url(#progress-green-gradient)" stroke-width="4.5" stroke-linecap="round" stroke-dasharray="0, 100"></path>
                            <!-- Percentage text -->
                            <text x="18" y="20.5" text-anchor="middle" font-size="9" fill="#374151" id="compliance-text-progress">0%</text>
                            <!-- Static label below the percentage -->
                            <text x="18" y="27" text-anchor="middle" font-size="3.5" fill="#4B5563" id="compliance-label-progress">COMPLIANT</text>
                        </svg>
                    </div>
                </div>
                
                <!--
                    Progress counts grid.  We display a tile for each error
                    category (outbound links, broken links, title/slug mismatches,
                    risky words, and image alt text issues).  When a count is zero
                    the tile appears with a green background; when greater than
                    zero it appears red.  We removed the pages scanned tile to
                    conserve space and added a tile for alt text issues.
                -->
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                    <!-- Outbound links count; color will be set dynamically in JS -->
                    <div id="outbound-progress-card" class="rounded-lg p-4">
                        <div id="outbound-count" class="text-2xl font-bold">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Outbound Links</div>
                    </div>
                    <!-- Broken links count; color will be set dynamically in JS -->
                    <div id="broken-progress-card" class="rounded-lg p-4">
                        <div id="broken-count" class="text-2xl font-bold">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Broken Links</div>
                    </div>
                    <!-- Title/slug mismatches count; color will be set dynamically -->
                    <div id="mismatch-progress-card" class="rounded-lg p-4">
                        <div id="mismatch-count" class="text-2xl font-bold">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Product Title/URL mismatches</div>
                    </div>
                    <!-- Risky words count; color will be set dynamically -->
                    <div id="banned-progress-card" class="rounded-lg p-4">
                        <div id="banned-count" class="text-2xl font-bold">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Risky Words</div>
                    </div>
                    <!-- Alt text issues count; color will be set dynamically -->
                    <div id="alt-progress-card" class="rounded-lg p-4">
                        <div id="alt-count" class="text-2xl font-bold">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Alt Text Issues</div>
                    </div>
                </div>
                
                <!-- The live URL display has been removed.  Previously this section
                     showed the current and recent URLs being scanned.  It has
                     been intentionally omitted per updated requirements to
                     simplify the crawl UI. -->

                
                <div class="text-center">
                    <button id="cancel-crawl-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">
                        Cancel GMC Scout
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden space-y-8 mt-8">
            <!-- Summary -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-8">
                    <!-- Results header: title and compliance bar -->
                    <div class="mb-6 text-center">
                        <!-- Dynamic results title will be populated via JavaScript to include domain and duration -->
                        <h3 id="results-title" class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                            Analysis complete
                        </h3>
                        <!-- Prominent compliance circular progress bar -->
                        <div class="flex justify-center mb-4">
                            <!-- Enlarge the final compliance bar to improve visibility.  The
                                 container remains transparent to avoid unwanted backgrounds. -->
                            <div class="relative" style="width: 160px; height: 160px; background: transparent;">
                                <svg id="compliance-svg-results" viewBox="0 0 36 36" class="w-full h-full" style="background: transparent; overflow: visible;">
                                    <!-- Gradient definitions specific to the results bar.  These mirrors the
                                         progress gradients but are suffixed with 'results' to avoid ID
                                         collisions.  The gradients provide a glossy, premium look to the
                                         progress arc. -->
                                    <defs>
                                        <linearGradient id="results-green-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stop-color="#6EE7B7" />
                                            <stop offset="100%" stop-color="#059669" />
                                        </linearGradient>
                                        <linearGradient id="results-orange-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stop-color="#FCD34D" />
                                            <stop offset="100%" stop-color="#EA580C" />
                                        </linearGradient>
                                        <linearGradient id="results-yellow-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stop-color="#FDE68A" />
                                            <stop offset="100%" stop-color="#EAB308" />
                                        </linearGradient>
                                        <linearGradient id="results-red-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stop-color="#FCA5A5" />
                                            <stop offset="100%" stop-color="#B91C1C" />
                                        </linearGradient>
                                    </defs>
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#FFFFFF" stroke-width="4.5"></path>
                                    <!-- Dynamic progress circle; stroke will be updated to the appropriate
                                         gradient via JS -->
                                    <path id="compliance-bar-results" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="url(#results-green-gradient)" stroke-width="4.5" stroke-linecap="round" stroke-dasharray="0, 100"></path>
                                    <text x="18" y="20.5" text-anchor="middle" font-size="9" fill="#374151" id="compliance-text-results">0%</text>
                                    <!-- Static label for results bar -->
                                    <text x="18" y="27" text-anchor="middle" font-size="3.5" fill="#4B5563" id="compliance-label-results">COMPLIANT</text>
                                </svg>
                            </div>
                        </div>
                        <!-- View report button below the compliance bar -->
                        <div class="flex justify-center mb-6">
                            <button id="export-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center space-x-2 shadow-md">
                                <i class="fas fa-file-pdf w-4 h-4"></i>
                                <span>View Detailed GMC Scout Report | Make Your Store 100% Google Compliant</span>
                            </button>
                        </div>
                    </div>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                    <!-- Note: The pages analyzed card has been removed.  We will display
                         the total number of pages scanned directly in the results header.
                         The following four cards show counts for outbound links,
                         broken links, product title/URL mismatches, and risky words.
                         Their background and text colors will be set dynamically in
                         JavaScript based on whether errors were found. -->
                    <div id="outbound-card" class="rounded-lg p-4">
                        <div id="final-outbound" class="text-2xl font-bold">-</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Outbound Links</div>
                    </div>
                    <div id="broken-card" class="rounded-lg p-4">
                        <div id="final-broken" class="text-2xl font-bold">-</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Broken Links</div>
                    </div>
                    <div id="mismatch-card" class="rounded-lg p-4">
                        <div id="final-mismatch" class="text-2xl font-bold">-</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Product Title/URL mismatches</div>
                    </div>
                    <div id="banned-card" class="rounded-lg p-4">
                        <div id="final-banned" class="text-2xl font-bold">-</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Risky Words</div>
                    </div>
                    <!-- Alt text issues summary -->
                    <div id="alt-card" class="rounded-lg p-4">
                        <div id="final-alt" class="text-2xl font-bold">-</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Alt Text Issues</div>
                    </div>
                    <!-- Duration card removed.  The duration will be displayed in the results header instead. -->
                </div>

                <div class="text-center">
                    <button id="new-crawl-btn" class="bg-black hover:bg-gray-800 text-yellow-200 px-6 py-3 rounded-lg transition-colors">
                        Start A New Check
                    </button>
                </div>
            </div>

            <!-- Outbound Links -->
            <div id="outbound-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-1">
                <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-external-link-alt w-5 h-5"></i>
                    <span>Outbound Links</span>
                </h4>
                <div id="outbound-list" class="space-y-1 max-h-32 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Broken Links -->
            <div id="broken-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-1">
                <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-exclamation-triangle w-5 h-5 text-red-500"></i>
                    <span>Broken Links (404 Errors)</span>
                </h4>
                <div id="broken-list" class="space-y-1 max-h-32 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Product Title & URL Slug Mismatches -->
            <div id="mismatch-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-4 hidden">
                <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-tags w-5 h-5 text-yellow-500"></i>
                    <span>Product Title &amp; URL Slug Mismatches</span>
                </h4>
                <div id="mismatch-list" class="space-y-1 max-h-48 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Risky words violations -->
            <div id="banned-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-4 hidden">
                <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-ban w-5 h-5 text-purple-500"></i>
                    <span>Risky Words</span>
                </h4>
                <div id="banned-list" class="space-y-1 max-h-48 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Alt text issues (image accessibility violations) -->
            <div id="alt-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-4 hidden">
                <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-image w-5 h-5 text-red-500"></i>
                    <span>Alt Text Issues</span>
                </h4>
                <div id="alt-list" class="space-y-1 max-h-48 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Information Modal: displayed when the info button is clicked -->
<div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-lg w-full p-6 text-gray-800 dark:text-gray-200">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-bold">GMC Scout: Your Complete Google Merchant Center Compliance Solution</h3>
            <button id="info-close-btn" type="button" aria-label="Close" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p class="text-sm leading-relaxed">
            We analyze 1,000+ critical data points using the latest Google Merchant Center policies and advanced AI to identify compliance issues before they impact your store. Our intelligent scanning engine combines automated detection with human expertise to catch the nuanced violations that generic tools miss.
        </p>
        <h4 class="mt-4 font-semibold">Why GMC Scout?</h4>
        <ul class="list-disc list-inside text-sm space-y-1 mt-2">
            <li>Comprehensive analysis of all known Google policy violations</li>
            <li>AI-powered detection that evolves with Google's changing requirements</li>
            <li>Real-time updates to our compliance database (last core update: August&nbsp;3rd,&nbsp;2025)</li>
            <li>Proactive identification of issues that could trigger account suspensions or product disapprovals</li>
        </ul>
        <p class="text-sm mt-4">Don't let hidden compliance issues cost you sales. GMCÂ Scout ensures your store meets Google's standards before problems arise, protecting your merchant account and maximizing your product visibility.</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let crawlInterval;
let currentSessionId;

// Form elements
const crawlForm = document.getElementById('crawl-form');
const urlInput = document.getElementById('url-input');
const startBtn = document.getElementById('start-crawl-btn');

// Section elements
const crawlSection = document.getElementById('crawl-section');
const progressSection = document.getElementById('progress-section');
const resultsSection = document.getElementById('results-section');

// Progress elements
const progressBar = document.getElementById('progress-bar');
const pagesCount = document.getElementById('pages-count');
const outboundCount = document.getElementById('outbound-count');
const brokenCount = document.getElementById('broken-count');
// Count of product title mismatches during the crawl
const mismatchCount = document.getElementById('mismatch-count');
const cancelBtn = document.getElementById('cancel-crawl-btn');

// Count of image alt text issues during the crawl
const altCount = document.getElementById('alt-count');

// Live URL display elements: these may be undefined because the live URL
// display has been removed from the UI.  The code checks for their
// existence before updating them.
const currentUrlDisplay = document.getElementById('current-url');
const recentUrlsDisplay = document.getElementById('recent-urls');

// Results elements
const finalPages = document.getElementById('final-pages');
const finalOutbound = document.getElementById('final-outbound');
const finalBroken = document.getElementById('final-broken');
// Dynamic results title: will be set to "Analysis complete for <domain> (duration)"
const resultsTitle = document.getElementById('results-title');
// Final count of product title mismatches
const finalMismatch = document.getElementById('final-mismatch');
const outboundList = document.getElementById('outbound-list');
const brokenList = document.getElementById('broken-list');

// Final count of image alt text issues
const finalAlt = document.getElementById('final-alt');

// List container for alt text issues and section reference
const altList = document.getElementById('alt-list');
const altSection = document.getElementById('alt-section');

// Mismatch elements for displaying product title vs URL slug mismatches
// When mismatches are present, the mismatch section will be shown and
// populated dynamically.  Otherwise it will remain hidden.  See
// updateMismatchSection() for details.
const mismatchSection = document.getElementById('mismatch-section');
const mismatchList = document.getElementById('mismatch-list');

// Banned keywords elements
const bannedSection = document.getElementById('banned-section');
const bannedList = document.getElementById('banned-list');
const bannedCount = document.getElementById('banned-count');
const finalBanned = document.getElementById('final-banned');

// Control buttons
const newCrawlBtn = document.getElementById('new-crawl-btn');
const exportPdfBtn = document.getElementById('export-pdf-btn');

// CAPTCHA elements and logic
const captchaQuestion = document.getElementById('captcha-question');
const captchaAnswerInput = document.getElementById('captcha-answer');
const refreshCaptchaBtn = document.getElementById('refresh-captcha');

async function loadCaptcha() {
    try {
        const resp = await fetch('/captcha');
        const data = await resp.json();
        captchaQuestion.textContent = data.question;
        captchaAnswerInput.value = '';
    } catch (error) {
        console.error('Failed to load CAPTCHA:', error);
        captchaQuestion.textContent = 'Error loading CAPTCHA';
    }
}

// Refresh CAPTCHA on button click
refreshCaptchaBtn.addEventListener('click', () => {
    loadCaptcha();
});

// Load a CAPTCHA when the page first loads
document.addEventListener('DOMContentLoaded', () => {
    loadCaptcha();
});

// Display title/slug mismatches in the results section.  Accepts an
// array of mismatches where each entry is a fourâ€‘tuple of
// [url, slug, title, similarity].  If no mismatches are present,
// the section remains hidden.  When populated, only the most recent
// 50 mismatches are displayed to keep the DOM lightweight.
function updateMismatchSection(mismatches) {
    // Clear previous entries
    mismatchList.innerHTML = '';
    // If there are no mismatches, hide the entire section and return.
    if (!mismatches || mismatches.length === 0) {
        mismatchSection.classList.add('hidden');
        return;
    }
    // Otherwise show the section and populate the list
    mismatchSection.classList.remove('hidden');
    // Show only the last 50 mismatches for performance
    mismatches.slice(-50).forEach(item => {
        const [url, slug, title, similarity] = item;
        const row = document.createElement('div');
        row.className = 'flex items-start space-x-2 p-2 border-b';
        row.innerHTML = `
            <i class="fas fa-exclamation-circle text-yellow-500 mt-1"></i>
            <div class="flex flex-col">
              <a href="${url}" class="text-primary-600 dark:text-primary-300 underline break-all" target="_blank">${title}</a>
              <span class="text-sm text-gray-500 dark:text-gray-400">Slug: ${slug} | Similarity: ${Math.round(similarity * 100)}%</span>
            </div>
        `;
        mismatchList.appendChild(row);
    });
}

// Display pages with banned keywords.  Accepts an array where each entry
// is a threeâ€‘tuple of [url, bannedWordsList, ratio].  If no violations are
// present, show a green checkmark message.  Otherwise list each page with
// the detected words and match percentage.
function updateBannedSection(pages) {
    // Clear previous entries
    bannedList.innerHTML = '';
    // If there are no violations, hide the section entirely
    if (!pages || pages.length === 0) {
        bannedSection.classList.add('hidden');
        return;
    }
    // Otherwise show and populate the list
    bannedSection.classList.remove('hidden');
    pages.slice(-50).forEach(item => {
        const [url, words, ratio] = item;
        const row = document.createElement('div');
        row.className = 'flex items-start space-x-2 p-2 border-b';
        row.innerHTML = `
            <i class="fas fa-ban text-purple-500 mt-1"></i>
            <div class="flex flex-col">
              <a href="${url}" class="text-primary-600 dark:text-primary-300 underline break-all" target="_blank">${url}</a>
              <span class="text-sm text-gray-500 dark:text-gray-400">Keywords: ${Array.isArray(words) ? words.join(', ') : words} | Match: ${Math.round((ratio || 0) * 100)}%</span>
            </div>
        `;
        bannedList.appendChild(row);
    });
}

// Display images with alt text issues.  Accepts an array where each entry is a
// fiveâ€‘tuple: [page_url, image_src, alt_text, reason, similarity].  If no
// issues are present, hide the section entirely.  Otherwise, show and
// populate the list.  We show up to 50 of the most recent issues to
// conserve DOM size.
function updateAltSection(issues) {
    // Clear previous entries
    if (typeof altList !== 'undefined') {
        altList.innerHTML = '';
    }
    // If there are no issues, hide the entire section
    if (!issues || issues.length === 0) {
        if (typeof altSection !== 'undefined') {
            altSection.classList.add('hidden');
        }
        return;
    }
    // Otherwise show and populate
    if (typeof altSection !== 'undefined') {
        altSection.classList.remove('hidden');
    }
    issues.slice(-50).forEach(item => {
        const [pageUrl, imageSrc, altText, reason, similarity] = item;
        const row = document.createElement('div');
        row.className = 'flex items-start space-x-2 p-2 border-b';
        // Create a descriptive row with an icon and details
        let simText = '';
        if (similarity !== null && similarity !== undefined && !isNaN(similarity)) {
            simText = ` | Similarity: ${Math.round(similarity * 100)}%`;
        }
        const altDisplay = altText && altText.length > 0 ? altText : '(missing)';
        // Extract image filename from the source URL for easier identification
        let fileName = '';
        if (imageSrc && typeof imageSrc === 'string') {
            try {
                fileName = imageSrc.split('?')[0].split('/').pop() || imageSrc;
            } catch (e) {
                fileName = imageSrc;
            }
        }
        row.innerHTML = `
            <i class="fas fa-image text-red-500 w-4 h-4 mt-1"></i>
            <div class="flex flex-col">
              <a href="${pageUrl}" class="text-primary-600 dark:text-primary-300 underline break-all" target="_blank">${pageUrl}</a>
              <span class="text-sm text-gray-500 dark:text-gray-400">Image: ${fileName} | Alt: ${altDisplay} | Reason: ${reason}${simText}</span>
            </div>
        `;
        altList.appendChild(row);
    });
}

// Update the circular compliance progress bar.  `value` should be a number
// between 0 and 100.  The `prefix` determines which SVG elements to update
// (either 'progress' for the live crawl or 'results' for the final report).
function updateCompliance(value, prefix) {
    const bar = document.getElementById('compliance-bar-' + prefix);
    const textEl = document.getElementById('compliance-text-' + prefix);
    if (!bar || !textEl) return;
    // Clamp value between 0 and 100
    let pct = parseFloat(value);
    if (isNaN(pct) || pct < 0) pct = 0;
    if (pct > 100) pct = 100;
    // Ensure the progress circle never moves backward during the live crawl.
    // When updating the progress bar (prefix === 'progress'), maintain the
    // highest compliance value seen so far.  This way the bar only moves
    // forward as the scan progresses.
    if (prefix === 'progress') {
        if (typeof window.lastComplianceProgressValue === 'undefined') {
            window.lastComplianceProgressValue = 0;
        }
        if (pct < window.lastComplianceProgressValue) {
            pct = window.lastComplianceProgressValue;
        } else {
            window.lastComplianceProgressValue = pct;
        }
    }
    // Set stroke dasharray so that the circle fills proportionally
    bar.setAttribute('stroke-dasharray', `${pct}, 100`);
    // For a consistent brand look, always colour the progress bar the same
    // deep green as the "View Detailed GMC Scout Report" button.  This makes
    // the bar match our primary call to action.  Regardless of the percentage,
    // the stroke colour remains constant.  The text still reflects the
    // actual percentage.
    const colour = '#059669';
    bar.setAttribute('stroke', colour);
    textEl.textContent = `${Math.round(pct)}%`;
}

// -----------------------------------------------------------------------------
// Colour interpolation helpers for the compliance progress bar
//
// These helper functions compute smooth colour transitions for the compliance
// progress bar.  Given a percentage value, the progress bar should shift
// gradually from red (low compliance) through yellow and orange towards green
// (high compliance).  We convert between hex and RGB, interpolate each
// channel, and then convert back to hex.

// Convert a hex colour like "#RRGGBB" into an object with r, g, b values.
function hexToRgb(hex) {
    const clean = hex.replace('#', '');
    const num = parseInt(clean, 16);
    return {
        r: (num >> 16) & 255,
        g: (num >> 8) & 255,
        b: num & 255
    };
}

// Convert r/g/b channel values back into a hex string.  Values outside the
// 0â€“255 range are clamped automatically by the bitwise operations.
function rgbToHex(r, g, b) {
    return '#' + ((1 << 24) + (r << 16) + (g << 8) + b)
        .toString(16)
        .slice(1)
        .toUpperCase();
}

// Linearly interpolate between two hex colours given a factor between 0 and 1.
// When factor is 0, the result equals the first colour; when factor is 1, the
// result equals the second colour.  Intermediate values blend the channels.
function interpolateColour(col1, col2, factor) {
    const start = hexToRgb(col1);
    const end = hexToRgb(col2);
    const r = Math.round(start.r + factor * (end.r - start.r));
    const g = Math.round(start.g + factor * (end.g - start.g));
    const b = Math.round(start.b + factor * (end.b - start.b));
    return rgbToHex(r, g, b);
}

// Compute an interpolated colour for the given compliance percentage.  The
// colour progression is defined as follows:
//   0â€“49%:   solid red (#DC2626) transitioning to yellow (#EAB308)
//   50â€“74%:  solid yellow (#EAB308) transitioning to orange (#EA580C)
//   75â€“100%: solid orange (#EA580C) transitioning to green (#059669)
//
// Percentages outside 0â€“100 are clamped.  The result is a single hex colour
// value used to colour the entire progress arc.
function getInterpolatedColour(pct) {
    // Simplified green progression: the compliance bar darkens as the percentage
    // increases.  At 0% the colour is pure white (#FFFFFF); at 100% it is a
    // deep green (#059669).  Values in between transition smoothly between
    // these two colours.  Percentages outside 0â€“100 are clamped.
    const p = Math.max(0, Math.min(100, pct));
    const factor = p / 100;
    return interpolateColour('#FFFFFF', '#059669', factor);
}

// Error handling helper
function showError(message, isTemporary = true) {
    let errorDiv = document.getElementById('error-message');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'error-message';
        errorDiv.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4';
        crawlSection.insertBefore(errorDiv, crawlForm);
    }
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    if (isTemporary) {
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
}

function hideError() {
    const errorDiv = document.getElementById('error-message');
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
}

// Update live URL display
function updateLiveUrlDisplay(data) {
    // Only update the live URL display if the elements exist.  This
    // prevents errors when the live URL section has been removed from
    // the DOM.  If not present, simply skip these updates.
    if (currentUrlDisplay && data.current_url) {
        currentUrlDisplay.textContent = data.current_url;
        currentUrlDisplay.title = data.current_url;
    }
    
    if (recentUrlsDisplay && data.recent_urls && data.recent_urls.length > 0) {
        recentUrlsDisplay.innerHTML = '';
        data.recent_urls.slice(-5).reverse().forEach(url => {
            const urlDiv = document.createElement('div');
            urlDiv.className = 'text-xs text-gray-600 dark:text-gray-400 truncate';
            urlDiv.textContent = url;
            urlDiv.title = url;
            recentUrlsDisplay.appendChild(urlDiv);
        });
    }
}

// Start crawl
crawlForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();
    
    const url = urlInput.value.trim();
    
    if (!url) {
        showError('Please enter a website URL');
        return;
    }
    
    // Basic URL validation
    if (!isValidUrl(url)) {
        showError('Please enter a valid website URL (e.g., example.com)');
        return;
    }
    
    try {
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin w-5 h-5"></i><span>Starting Analysis...</span>';
        
        console.log('Starting crawl for:', url);
        
        // Include the user's CAPTCHA answer in the crawl request.  If the
        // CAPTCHA answer is missing, the server will reject the request.
        const captchaValue = captchaAnswerInput.value.trim();
        const response = await fetch('/crawl', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                captcha_answer: captchaValue
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentSessionId = data.session_id;
            console.log('Crawl started with session:', currentSessionId);
            showProgressSection();
            startPolling();
        } else {
            console.error('Crawl failed:', data.error);
            showError(data.error || 'Failed to start crawl');
            resetForm();
        }
    } catch (error) {
        console.error('Network error starting crawl:', error);
        showError('Network error. Please check your connection and try again.');
        resetForm();
    }
});

// Basic URL validation
function isValidUrl(url) {
    // Remove protocol if present for validation
    const cleanUrl = url.replace(/^https?:\/\//, '');
    
    // Must contain at least one dot and valid characters
    const urlPattern = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}(\/.*)?$/;
    
    return urlPattern.test(cleanUrl) && cleanUrl.length > 3;
}

// Show progress section
function showProgressSection() {
    crawlSection.style.display = 'none';
    progressSection.classList.remove('hidden');
    resultsSection.classList.add('hidden');
    
    // Reset progress displays
    progressBar.style.width = '0%';
    if (pagesCount) {
        pagesCount.textContent = '0';
    }
    outboundCount.textContent = '0';
    brokenCount.textContent = '0';
    // Reset live URL display only if those elements exist.
    if (currentUrlDisplay) {
        currentUrlDisplay.textContent = 'Starting crawl...';
    }
    if (recentUrlsDisplay) {
        recentUrlsDisplay.innerHTML = '';
    }

    // Reset client-side progress tracker so that the next crawl starts
    // from zero. Without this, the previous crawl's progress would carry
    // over and the bar could start at 100%.
    lastProgressValue = 0;

    // Reset compliance progress tracker for the live circular bar.  Without
    // resetting this, a new crawl would inherit the previous crawl's
    // compliance value and start the circle partially filled.
    window.lastComplianceProgressValue = 0;
}

// Start polling for status
function startPolling() {
    let pollAttempts = 0;
    // Poll every 500ms instead of 1s for smoother UI updates.  The number of
    // attempts is doubled accordingly to maintain the same overall timeout
    // window (6 minutes total).
    const maxPollAttempts = 720; // 6 minutes at 0.5 second intervals
    
    // Use a shorter interval (500ms) for more frequent status updates.  This
    // provides a near-real-time feel while avoiding excessive load on the server.
    crawlInterval = setInterval(async () => {
        pollAttempts++;
        
        try {
            // Include session_id in query to ensure correct session resolution
            const response = await fetch(`/status?session_id=${encodeURIComponent(currentSessionId)}`);
            
            if (response.ok) {
                const data = await response.json();
                // Update progress in a try/catch so that any UI error doesnâ€™t
                // block the completion callback below.  If updateProgress
                // throws, we still proceed to check the completion flag.
                try {
                    updateProgress(data);
                } catch (uiError) {
                    console.error('Progress update error:', uiError);
                }
                // If the crawl is complete, transition to the results view.
                if (data.is_complete) {
                    clearInterval(crawlInterval);
                    showResults(data);
                }
            } else if (response.status === 404) {
                console.error('Crawl session not found');
                clearInterval(crawlInterval);
                showError('Crawl session expired. Please start a new analysis.');
                resetAll();
            } else {
                console.error('Failed to fetch status:', response.status);
            }
        } catch (error) {
            console.error('Error polling status:', error);
        }
        
        // Timeout protection
        if (pollAttempts >= maxPollAttempts) {
            clearInterval(crawlInterval);
            showError('Analysis is taking longer than expected. Please try again.');
            resetAll();
        }
    }, 500);
}

// Maintain the maximum progress observed so that the bar never regresses.
let lastProgressValue = 0;
// Maintain maximum observed counts and denominators for each check so
// that the displayed ratios never decrease or jump backwards during a
// crawl.  These variables track the highest values seen so far for
// mismatches, banned (risky words) and alt text issues.  When new
// values are lower than the previous ones, we retain the previous
// counts/denominators to avoid confusing jumps in the UI.
let lastMismatchCount = 0;
let lastMismatchDenom = 0;
let lastBannedCount = 0;
let lastBannedDenom = 0;
let lastAltCount = 0;
let lastAltDenom = 0;

// Update progress display
function updateProgress(data) {
    // If the reported progress is lower than what we've already displayed,
    // keep the last value.  This prevents the progress bar from jumping
    // backwards due to inconsistent status responses from the server.
    let progressValue = data.progress || 0;
    if (progressValue < lastProgressValue) {
        progressValue = lastProgressValue;
    } else {
        lastProgressValue = progressValue;
    }
    progressBar.style.width = progressValue + '%';
    if (pagesCount) {
        pagesCount.textContent = data.pages_scanned || 0;
    }
    // Display counts as "errors/total_pages" to convey how many pages were
    // checked.  When total pages is zero, just show the error count.  This
    // helps users see that checks are running even when there are no errors.
    // Determine denominators for each check category.  Outbound and broken
    // link checks run on every scanned page, so use pages_scanned.  For
    // productâ€‘specific checks, use the corresponding counters returned
    // from the server (title_check_pages, banned_check_pages, alt_check_pages).
    const pagesTotal = data.pages_scanned || 0;
    const titleCheckTotal = data.title_check_pages || 0;
    const bannedCheckTotal = data.banned_check_pages || 0;
    // For alt text, use the number of images scanned (alt_checks_total) instead of
    // product pages.  This provides a unique denominator for the alt text
    // check separate from the other productâ€‘specific checks.
    const altCheckTotal = data.alt_checks_total || 0;

    // Outbound and broken counts: display errors/total pages scanned along with an icon
    const outboundErrors = data.outbound_count || 0;
    const outboundRatio = pagesTotal > 0 ? `${outboundErrors}/${pagesTotal}` : `${outboundErrors}`;
    const outboundIconClass = outboundErrors > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
    outboundCount.innerHTML = `${outboundRatio} <i class="fas ${outboundIconClass} ml-1"></i>`;

    const brokenErrors = data.broken_count || 0;
    const brokenRatio = pagesTotal > 0 ? `${brokenErrors}/${pagesTotal}` : `${brokenErrors}`;
    const brokenIconClass = brokenErrors > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
    brokenCount.innerHTML = `${brokenRatio} <i class="fas ${brokenIconClass} ml-1"></i>`;
    // Update live count of product title mismatches.  If the backâ€‘end
    // doesn't provide a list yet, default to zero.
    const mismatchLen = (data.title_mismatches && Array.isArray(data.title_mismatches)) ? data.title_mismatches.length : 0;
    // For mismatches (title/slug), use titleCheckTotal as the denominator
    // Always display a ratio if possible.  If no product pages were
    // identified (titleCheckTotal is zero), fall back to the total
    // pages scanned so that users still see a denominator.  If pagesTotal
    // is also zero, simply show the error count.
    let mismatchDenom = titleCheckTotal > 0 ? titleCheckTotal : (pagesTotal > 0 ? pagesTotal : 0);
    // Enforce monotonic increase for mismatch counts and denominators
    let displayMismatchCount = mismatchLen;
    let displayMismatchDenom = mismatchDenom;
    if (mismatchLen < lastMismatchCount) {
        displayMismatchCount = lastMismatchCount;
    } else {
        lastMismatchCount = mismatchLen;
    }
    if (mismatchDenom < lastMismatchDenom) {
        displayMismatchDenom = lastMismatchDenom;
    } else {
        lastMismatchDenom = mismatchDenom;
    }
    // Set mismatch count text with icon
    const mismatchRatio = displayMismatchDenom > 0 ? `${displayMismatchCount}/${displayMismatchDenom}` : `${displayMismatchCount}`;
    const mismatchIconClass = displayMismatchCount > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
    mismatchCount.innerHTML = `${mismatchRatio} <i class="fas ${mismatchIconClass} ml-1"></i>`;
    // Update live count of pages with banned keywords
    const bannedLen = (data.banned_keyword_pages && Array.isArray(data.banned_keyword_pages)) ? data.banned_keyword_pages.length : 0;
    if (bannedCount) {
        let bannedDenom = bannedCheckTotal > 0 ? bannedCheckTotal : (pagesTotal > 0 ? pagesTotal : 0);
        // Enforce monotonic increase for banned counts and denominators
        let displayBannedCount = bannedLen;
        let displayBannedDenom = bannedDenom;
        if (bannedLen < lastBannedCount) {
            displayBannedCount = lastBannedCount;
        } else {
            lastBannedCount = bannedLen;
        }
        if (bannedDenom < lastBannedDenom) {
            displayBannedDenom = lastBannedDenom;
        } else {
            lastBannedDenom = bannedDenom;
        }
        const bannedRatio = displayBannedDenom > 0 ? `${displayBannedCount}/${displayBannedDenom}` : `${displayBannedCount}`;
        const bannedIconClass = displayBannedCount > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
        bannedCount.innerHTML = `${bannedRatio} <i class="fas ${bannedIconClass} ml-1"></i>`;
    }

    // Update live count of image alt text issues.  Prefer the explicit
    // alt_text_count provided by the server, which is a simple integer.
    // Fall back to counting the alt_text_issues array if the count is not
    // provided.  If neither is available, default to zero.  This avoids
    // scenarios where the alt_text_issues array is not serialised as an
    // array (e.g. when transferred via JSON) or truncated.
    let altLen = 0;
    if (typeof data.alt_text_count === 'number') {
        altLen = data.alt_text_count;
    } else if (data.alt_text_issues && Array.isArray(data.alt_text_issues)) {
        altLen = data.alt_text_issues.length;
    }
    if (typeof altCount !== 'undefined') {
        // For alt text issues, use the total images scanned; if none yet,
        // fall back to the total pages scanned for visibility.
        // For the alt text denominator, prefer the total number of images scanned.  If the
        // crawler has not yet reported alt_checks_total but there are already alt
        // issues counted (altLen > 0), use the number of issues as the denominator.
        // This prevents the ratio from falling back to the page count (pagesTotal)
        // when the image count is not yet available.  Only when there are no
        // alt issues and no image count should it default to pagesTotal.
        let altDenom;
        if (altCheckTotal > 0) {
            altDenom = altCheckTotal;
        } else if (altLen > 0) {
            altDenom = altLen;
        } else {
            altDenom = pagesTotal > 0 ? pagesTotal : 0;
        }
        // Enforce monotonic increase for alt counts and denominators
        let displayAltCount = altLen;
        let displayAltDenom = altDenom;
        if (altLen < lastAltCount) {
            displayAltCount = lastAltCount;
        } else {
            lastAltCount = altLen;
        }
        if (altDenom < lastAltDenom) {
            displayAltDenom = lastAltDenom;
        } else {
            lastAltDenom = altDenom;
        }
        const altRatio = displayAltDenom > 0 ? `${displayAltCount}/${displayAltDenom}` : `${displayAltCount}`;
        const altIconClass = displayAltCount > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
        altCount.innerHTML = `${altRatio} <i class="fas ${altIconClass} ml-1"></i>`;
    }

    // Dynamically adjust card colors based on whether any errors have been detected.
    // When a count is zero, the card is rendered with a green background and text. If
    // the count is greater than zero, use a red background and text.  This
    // mirrors the styling in the results section.
    function applyProgressCardStyles(cardEl, numberEl, count) {
        const baseCardClasses = 'rounded-lg p-4';
        const baseNumberClasses = 'text-2xl font-bold';
        if (count > 0) {
            cardEl.className = baseCardClasses + ' bg-red-50 dark:bg-red-900/20';
            numberEl.className = baseNumberClasses + ' text-red-600';
        } else {
            cardEl.className = baseCardClasses + ' bg-green-50 dark:bg-green-900/20';
            numberEl.className = baseNumberClasses + ' text-green-600';
        }
    }
    // Select progress cards and apply styles
    const outboundCardProg = document.getElementById('outbound-progress-card');
    const brokenCardProg = document.getElementById('broken-progress-card');
    const mismatchCardProg = document.getElementById('mismatch-progress-card');
    const bannedCardProg = document.getElementById('banned-progress-card');
    const altCardProg = document.getElementById('alt-progress-card');
    applyProgressCardStyles(outboundCardProg, outboundCount, data.outbound_count || 0);
    applyProgressCardStyles(brokenCardProg, brokenCount, data.broken_count || 0);
    applyProgressCardStyles(mismatchCardProg, mismatchCount, mismatchLen);
    applyProgressCardStyles(bannedCardProg, bannedCount, bannedLen);
    applyProgressCardStyles(altCardProg, altCount, altLen);
    
    // Update live URL display
    updateLiveUrlDisplay(data);

    // Show any product title/URL slug mismatches discovered so far.  Wrap
    // this call in a try/catch so that a failure to update mismatches
    // doesnâ€™t interrupt the progress loop.
    try {
        updateMismatchSection(data.title_mismatches);
        // Update banned keywords section
        updateBannedSection(data.banned_keyword_pages);
        // Update alt text issues section
        updateAltSection(data.alt_text_issues);
        // Update compliance progress circle
        updateCompliance(data.compliance || 0, 'progress');
    } catch (e) {
        console.error('Mismatch section update failed:', e);
    }
    
    console.log(`Progress: ${progressValue}% - Pages: ${data.pages_scanned}, Outbound: ${data.outbound_count}, Broken: ${data.broken_count}`);
}

// Show results
function showResults(data) {
    progressSection.classList.add('hidden');
    resultsSection.classList.remove('hidden');
    
    // Update summary counts and dynamically set card colors based on whether
    // errors were found.  Green indicates zero issues; red indicates one or more.
    const pagesScanned = data.pages_scanned || 0;
    const outboundLen = data.outbound_count || 0;
    const brokenLen = data.broken_count || 0;
    const mismatchesFinal = (data.title_mismatches && Array.isArray(data.title_mismatches)) ? data.title_mismatches.length : 0;
    const bannedFinal = (data.banned_keyword_pages && Array.isArray(data.banned_keyword_pages)) ? data.banned_keyword_pages.length : 0;
    // Determine the number of alt text issues.  Use the serverâ€‘provided
    // alt_text_count if available, otherwise fall back to the length of
    // the alt_text_issues array.  This ensures the count is accurate
    // even if the array is truncated or not serialised as an array.
    let altFinal = 0;
    if (typeof data.alt_text_count === 'number') {
        altFinal = data.alt_text_count;
    } else if (data.alt_text_issues && Array.isArray(data.alt_text_issues)) {
        altFinal = data.alt_text_issues.length;
    }

    // Display counts as "errors/total_pages" in the results summary.  When
    // pagesScanned is zero, show only the error count.  The raw counts are
    // still used for colour styling below.
    // For outbound and broken links, display the ratio along with an icon
    const finalOutboundRatio = pagesScanned > 0 ? `${outboundLen}/${pagesScanned}` : `${outboundLen}`;
    const finalOutboundIcon = outboundLen > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
    finalOutbound.innerHTML = `${finalOutboundRatio} <i class="fas ${finalOutboundIcon} ml-1"></i>`;

    const finalBrokenRatio = pagesScanned > 0 ? `${brokenLen}/${pagesScanned}` : `${brokenLen}`;
    const finalBrokenIcon = brokenLen > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
    finalBroken.innerHTML = `${finalBrokenRatio} <i class="fas ${finalBrokenIcon} ml-1"></i>`;
    // For mismatches, banned keywords and alt text issues, use the specific
    // number of pages or images checked returned from the server.  This
    // ensures that each ratio reflects the correct denominator for that
    // category.  Fallback to pagesScanned if the specific counter is not
    // provided.
    // Determine denominators for each result category.  Use the
    // checkâ€‘specific totals if provided.  If these are zero, fall back to the
    // overall pages scanned so that ratios are always displayed.  When
    // pagesScanned is also zero, show only the error counts.
    const titleTotalFinal = (data.title_check_pages && data.title_check_pages > 0) ? data.title_check_pages : (pagesScanned > 0 ? pagesScanned : 0);
    const bannedTotalFinal = (data.banned_check_pages && data.banned_check_pages > 0) ? data.banned_check_pages : (pagesScanned > 0 ? pagesScanned : 0);
    // For the alt text denominator in the final results, prefer the total
    // number of images scanned (alt_checks_total).  If that is zero but
    // alt_text_count is available (indicating issues were found), use
    // alt_text_count as the denominator.  Otherwise fall back to the
    // number of pages scanned (or alt_check_pages if provided) so a ratio
    // is always displayed.
    let altTotalFinal;
    if (data.alt_checks_total && data.alt_checks_total > 0) {
        altTotalFinal = data.alt_checks_total;
    } else if (typeof data.alt_text_count === 'number' && data.alt_text_count > 0) {
        altTotalFinal = data.alt_text_count;
    } else if (data.alt_check_pages && data.alt_check_pages > 0) {
        altTotalFinal = data.alt_check_pages;
    } else {
        altTotalFinal = pagesScanned > 0 ? pagesScanned : 0;
    }
    const finalMismatchRatio = titleTotalFinal > 0 ? `${mismatchesFinal}/${titleTotalFinal}` : `${mismatchesFinal}`;
    const finalMismatchIcon = mismatchesFinal > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
    finalMismatch.innerHTML = `${finalMismatchRatio} <i class="fas ${finalMismatchIcon} ml-1"></i>`;
    if (finalBanned) {
        const finalBannedRatio = bannedTotalFinal > 0 ? `${bannedFinal}/${bannedTotalFinal}` : `${bannedFinal}`;
        const finalBannedIcon = bannedFinal > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
        finalBanned.innerHTML = `${finalBannedRatio} <i class="fas ${finalBannedIcon} ml-1"></i>`;
    }
    if (typeof finalAlt !== 'undefined') {
        const finalAltRatio = altTotalFinal > 0 ? `${altFinal}/${altTotalFinal}` : `${altFinal}`;
        const finalAltIcon = altFinal > 0 ? 'fa-times-circle text-red-600' : 'fa-check-circle text-green-600';
        finalAlt.innerHTML = `${finalAltRatio} <i class="fas ${finalAltIcon} ml-1"></i>`;
    }
    // Define a helper to apply consistent styling to summary cards based on count
    function applyCardStyles(cardEl, numberEl, count) {
        const baseCardClasses = 'rounded-lg p-4';
        const baseNumberClasses = 'text-2xl font-bold';
        if (count > 0) {
            // There are errors: use red theme
            cardEl.className = baseCardClasses + ' bg-red-50 dark:bg-red-900/20';
            numberEl.className = baseNumberClasses + ' text-red-600';
        } else {
            // No errors: use green theme
            cardEl.className = baseCardClasses + ' bg-green-50 dark:bg-green-900/20';
            numberEl.className = baseNumberClasses + ' text-green-600';
        }
    }
    // Apply styles to each card
    const outboundCard = document.getElementById('outbound-card');
    const brokenCard = document.getElementById('broken-card');
    const mismatchCard = document.getElementById('mismatch-card');
    const bannedCard = document.getElementById('banned-card');
    const altCard = document.getElementById('alt-card');
    applyCardStyles(outboundCard, finalOutbound, outboundLen);
    applyCardStyles(brokenCard, finalBroken, brokenLen);
    applyCardStyles(mismatchCard, finalMismatch, mismatchesFinal);
    applyCardStyles(bannedCard, finalBanned, bannedFinal);
    applyCardStyles(altCard, finalAlt, altFinal);
    
    // Determine the crawl duration if available.  We will include this in the
    // results header instead of a separate card.
    let durationText = '';
    if (data.start_time && data.end_time) {
        try {
            const start = new Date(data.start_time);
            const end = new Date(data.end_time);
            const duration = Math.round((end - start) / 1000);
            durationText = `${duration}s`;
        } catch (e) {
            durationText = '';
        }
    }
    
    // Set results header to include the scanned domain and duration.  If
    // domain is missing, fall back to a generic term.  The duration
    // (durationText) is appended in parentheses when available.
    const domainLabel = (data.domain && data.domain.length > 0) ? data.domain : 'your site';
    // Build header: include domain, duration and pages scanned
    const headerParts = [];
    headerParts.push(`Analysis complete for ${domainLabel}`);
    if (durationText) {
        headerParts.push(`(${durationText})`);
    }
    headerParts.push(`- ${pagesScanned} pages analyzed`);
    resultsTitle.textContent = headerParts.join(' ');

    // Conditionally display outbound links.  Hide the section entirely if
    // no outbound links were found.  Otherwise show and populate the list.
    const outboundSection = document.getElementById('outbound-section');
    const outboundDetails = data.outbound_links_details || null;
    const outboundArray = data.outbound_links || [];
    if (outboundArray && outboundArray.length > 0) {
        outboundSection.classList.remove('hidden');
        displayLinks(outboundArray, outboundList, 'outbound', outboundDetails);
    } else {
        outboundSection.classList.add('hidden');
    }

    // Conditionally display broken links.  Hide the section if no broken links.
    const brokenSectionEl = document.getElementById('broken-section');
    const brokenDetails = data.broken_links_details || null;
    const brokenArray = data.broken_links || [];
    if (brokenArray && brokenArray.length > 0) {
        brokenSectionEl.classList.remove('hidden');
        displayLinks(brokenArray, brokenList, 'broken', brokenDetails);
    } else {
        brokenSectionEl.classList.add('hidden');
    }

    // Display title/slug mismatches in the results view
    updateMismatchSection(data.title_mismatches);
    // Display banned keyword pages in the results view
    updateBannedSection(data.banned_keyword_pages);
    // Display alt text issues in the results view
    updateAltSection(data.alt_text_issues);
    // Update compliance circle for results
    updateCompliance(data.compliance || 0, 'results');
    
    // Show error if any
    if (data.error) {
        showError(`Analysis completed with warning: ${data.error}`, false);
    }
    
    console.log('Results displayed successfully');
}

// Display links in list
function displayLinks(links, container, type, details = null) {
    container.innerHTML = '';

    // If detailed data is provided (list of [source_page, link] pairs), build a
    // lookup map from link to its source.  We will still iterate over the
    // full list of links to ensure that links without a recorded source are
    // displayed.  When a source exists, show "Found on: â€¦" beneath the link.
    let detailsMap = null;
    if ((type === 'broken' || type === 'outbound') && details && details.length > 0) {
        detailsMap = {};
        details.forEach(item => {
            const [source, link] = item;
            if (!detailsMap[link]) {
                detailsMap[link] = source;
            }
        });
    }

    // If no links, show an empty state
    if (!links || links.length === 0) {
        const emptyState = document.createElement('div');
        // Reduce the vertical padding when there are no results to
        // conserve space.  A smaller py value keeps the panel compact.
        emptyState.className = 'text-center py-2 text-gray-500 dark:text-gray-400';
        emptyState.innerHTML = `
            <i class="fas fa-check-circle w-8 h-8 mx-auto mb-2 text-green-500"></i>
            <p>No ${type === 'broken' ? 'broken' : 'outbound'} links found</p>
        `;
        container.appendChild(emptyState);
        return;
    }

    // Limit display to prevent browser slowdown
    const maxDisplay = 500;
    const linksToDisplay = links.slice(0, maxDisplay);

    linksToDisplay.forEach(link => {
        // If a details map is provided and has a source for this link, render
        // it with a source row.
        if (detailsMap && detailsMap[link]) {
            const source = detailsMap[link];
            const row = document.createElement('div');
            row.className = 'flex flex-col space-y-1 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors';
            const linkRow = document.createElement('div');
            linkRow.className = 'flex items-center justify-between';
            const linkInfo = document.createElement('div');
            linkInfo.className = 'flex items-center space-x-3 flex-1 min-w-0';
            const iconElem = document.createElement('i');
            if (type === 'broken') {
                iconElem.className = 'fas fa-exclamation-triangle text-red-500 w-4 h-4 flex-shrink-0';
            } else {
                const isEmail = link.startsWith('mailto:');
                if (isEmail) {
                    iconElem.className = 'fas fa-envelope text-blue-500 w-4 h-4 flex-shrink-0';
                } else {
                    iconElem.className = 'fas fa-external-link-alt text-gray-500 w-4 h-4 flex-shrink-0';
                }
            }
            const span = document.createElement('span');
            if (type === 'broken') {
                span.className = 'text-sm text-red-700 dark:text-red-300 truncate';
            } else {
                span.className = 'text-sm text-gray-700 dark:text-gray-300 truncate';
            }
            span.textContent = link;
            span.title = link;
            linkInfo.appendChild(iconElem);
            linkInfo.appendChild(span);
            // Do not create a clickable anchor; append the link info directly.
            linkRow.appendChild(linkInfo);
            const sourceRow = document.createElement('div');
            sourceRow.className = 'text-xs text-gray-500 dark:text-gray-400 truncate';
            sourceRow.textContent = `Found on: ${source}`;
            sourceRow.title = source;
            row.appendChild(linkRow);
            row.appendChild(sourceRow);
            container.appendChild(row);
        } else {
            // No details for this link; render a simple single-line entry
            const linkElement = document.createElement('div');
            linkElement.className = 'flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors';
            const isEmail = link.startsWith('mailto:');
            let iconClass;
            let linkColor = 'text-gray-700 dark:text-gray-300';
            if (type === 'broken') {
                iconClass = 'fas fa-exclamation-triangle text-red-500';
                linkColor = 'text-red-700 dark:text-red-300';
            } else if (isEmail) {
                iconClass = 'fas fa-envelope text-blue-500';
            } else {
                iconClass = 'fas fa-external-link-alt text-gray-500';
            }
            linkElement.innerHTML = `
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <i class="${iconClass} w-4 h-4 flex-shrink-0"></i>
                    <span class="text-sm ${linkColor} truncate" title="${link}">${link}</span>
                </div>
                <!-- External link anchor removed -->
            `;
            container.appendChild(linkElement);
        }
    });
    // Show count if truncated
    if (links.length > maxDisplay) {
        const moreElement = document.createElement('div');
        moreElement.className = 'text-center py-2 text-gray-500 dark:text-gray-400 text-sm';
        moreElement.textContent = `... and ${links.length - maxDisplay} more (use export to see all)`;
        container.appendChild(moreElement);
    }
}

// Cancel crawl
cancelBtn.addEventListener('click', async () => {
    try {
        const response = await fetch(`/cancel?session_id=${encodeURIComponent(currentSessionId)}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            clearInterval(crawlInterval);
            showError('Analysis cancelled', true);
            resetAll();
        } else {
            console.error('Failed to cancel crawl');
            showError('Failed to cancel analysis');
        }
    } catch (error) {
        console.error('Error cancelling crawl:', error);
        showError('Error cancelling analysis');
    }
});

// New crawl
newCrawlBtn.addEventListener('click', () => {
    resetAll();
});

// Export function â€“ only PDF export is supported
exportPdfBtn.addEventListener('click', async () => {
    await exportResults('pdf');
});

async function exportResults(format) {
    try {
        const response = await fetch(`/export/${format}?session_id=${encodeURIComponent(currentSessionId)}`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || `crawl_results.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            showError(`Failed to export ${format.toUpperCase()} file`);
        }
    } catch (error) {
        console.error('Export error:', error);
        showError(`Error exporting ${format.toUpperCase()} file`);
    }
}

// Reset form
function resetForm() {
    startBtn.disabled = false;
    startBtn.innerHTML = '<i class="fas fa-search w-5 h-5"></i><span>Start Link Analysis</span>';
}

// Reset all sections
function resetAll() {
    crawlSection.style.display = 'block';
    progressSection.classList.add('hidden');
    resultsSection.classList.add('hidden');
    
    // Reset form
    crawlForm.reset();
    resetForm();
    hideError();
    
    // Reset progress
    progressBar.style.width = '0%';
    if (pagesCount) {
        pagesCount.textContent = '0';
    }
    outboundCount.textContent = '0';
    brokenCount.textContent = '0';
    // Only reset live URL fields if they exist (the live URL display
    // section may have been removed).  Without these checks,
    // currentUrlDisplay and recentUrlsDisplay may be null and cause
    // errors.
    if (currentUrlDisplay) {
        currentUrlDisplay.textContent = 'Starting crawl...';
    }
    if (recentUrlsDisplay) {
        recentUrlsDisplay.innerHTML = '';
    }

    // Reset mismatch counters
    if (typeof mismatchCount !== 'undefined') mismatchCount.textContent = '0';
    if (typeof finalMismatch !== 'undefined') finalMismatch.textContent = '-';

    // Reset client-side progress tracker so the next crawl starts fresh
    lastProgressValue = 0;
    
    // Clear session
    currentSessionId = null;
    
    if (crawlInterval) {
        clearInterval(crawlInterval);
        crawlInterval = null;
    }

    // Reset mismatch display.  Hide the mismatch section until the next
    // status poll reveals whether mismatches are present.  Clear any
    // previous content in the list.
    mismatchSection.classList.add('hidden');
    mismatchList.innerHTML = '';

    // Reset banned keywords display.  Hide the section and clear list.
    bannedSection.classList.add('hidden');
    bannedList.innerHTML = '';

    // Reset alt text issues display.  Hide the section and clear list.
    altSection.classList.add('hidden');
    altList.innerHTML = '';

    // Reset alt counts
    if (typeof altCount !== 'undefined') altCount.textContent = '0';
    if (typeof finalAlt !== 'undefined') finalAlt.textContent = '-';

    // Reset client-side trackers for monotonic counts and denominators. Without
    // resetting these, values from a previous crawl may persist and cause
    // the ratios to display incorrectly when a new crawl begins.  Each
    // variable tracks the highest observed count/denominator for its
    // respective category; resetting them here ensures a fresh start.
    lastMismatchCount = 0;
    lastMismatchDenom = 0;
    lastBannedCount = 0;
    lastBannedDenom = 0;
    lastAltCount = 0;
    lastAltDenom = 0;

    // Always fetch a new CAPTCHA when resetting.  Without this, the page
    // would continue to display the previous CAPTCHA question, causing
    // submissions to fail because the server expects a fresh answer.
    loadCaptcha();
    
    console.log('Reset complete');
}

// Handle page refresh/close
window.addEventListener('beforeunload', () => {
    if (crawlInterval) {
        clearInterval(crawlInterval);
    }
});

// Info modal logic: show/hide the modal when the info button is clicked
const infoBtn = document.getElementById('info-btn');
const infoModal = document.getElementById('info-modal');
const infoCloseBtn = document.getElementById('info-close-btn');
if (infoBtn && infoModal && infoCloseBtn) {
    infoBtn.addEventListener('click', () => {
        infoModal.classList.remove('hidden');
    });
    infoCloseBtn.addEventListener('click', () => {
        infoModal.classList.add('hidden');
    });
    // Clicking on the backdrop (outside the modal content) closes the modal
    infoModal.addEventListener('click', (e) => {
        if (e.target === infoModal) {
            infoModal.classList.add('hidden');
        }
    });
}

// Auto-format URL input
urlInput.addEventListener('blur', () => {
    let url = urlInput.value.trim();
    if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
        // Don't auto-add protocol, let the backend handle it
        urlInput.value = url;
    }
});

// Add input validation feedback
urlInput.addEventListener('input', (e) => {
    const url = e.target.value.trim();
    if (url && !isValidUrl(url)) {
        urlInput.classList.add('border-red-300');
    } else {
        urlInput.classList.remove('border-red-300');
    }
});

// Initialize
console.log('Link Checker initialized');
</script>
{% endblock %}
